# **Тестовое задание для стажёра Backend (осенняя волна 2025)**

## **Сервис назначения ревьюеров для Pull Request’ов**

Внутри команды требуется единый микросервис, который автоматически назначает ревьюеров на Pull Request’ы (PR), а также позволяет управлять командами и участниками. Взаимодействие происходит исключительно через HTTP API.

## **Описание задачи**

Необходимо реализовать сервис, который назначает ревьюеров на PR из команды автора, позволяет выполнять переназначение ревьюверов и получать список PR’ов, назначенных конкретному пользователю, а также управлять командами и активностью пользователей. После merge PR изменение состава ревьюверов запрещено.

## **Общие вводные**

**Пользователь (User)** — участник команды с уникальным идентификатором, именем и флагом активности `isActive`.

**Команда (Team)** — группа пользователей с уникальным именем.

**Pull Request (PR)** — сущность с идентификатором, названием, автором, статусом `OPEN|MERGED`и списком назначенных ревьюверов (до 2).

1. При создании PR автоматически назначаются **до двух** активных ревьюверов из **команды автора**, исключая самого автора.
2. Переназначение заменяет одного ревьювера на случайного **активного** участника **из команды заменяемого** ревьювера.
3. После `MERGED` менять список ревьюверов **нельзя**.
4. Если доступных кандидатов меньше двух, назначается доступное количество (0/1).

## **Условия**

* Используйте этот API (OpenAPI-спецификация будет предоставлена отдельным файлом — `openapi.yaml`).
* Объём данных умеренный (до 20 команд и до 200 пользователей), RPS — 5, SLI времени ответа — 300 мс, SLI успешности — 99.9%.
* Пользователь с `isActive = false` не должен назначаться на ревью.
* Операция merge должна быть **идемпотентной** — повторный вызов не приводит к ошибке и возвращает актуальное состояние PR.
* Сервис и его зависимости должны подниматься командой **docker-compose up**. Если решение предусматривает миграции, они также должны применяться при выполнении этой команды. Сервис должен быть доступен на порту 8080.
* Учтите, что соблюдение условий по поднятию сервиса ускорит и упростит проверку вашей работы наставниками.

## **Дополнительные задания**

Эти задания не являются обязательными, но выполнение всех или части из них даст вам преимущество перед другими кандидатами.

* Добавить простой эндпоинт статистики (например, количество назначений по пользователям и/или по PR).
* Провести нагрузочное тестирование полученного решения и приложить краткие результаты тестирования к решению.
* Добавить метод массовой деактивации пользователей команды и безопасную переназначаемость открытых PR (стремиться уложиться в 100 мс для средних объёмов данных).
* Реализовать интеграционное или E2E-тестирование.
* Описать конфигурацию линтера.

## **Требования по стеку**

**Язык сервиса:** предпочтительным будет Go, при этом вы можете выбрать любой, удобный вам.

**База данных:** предпочтительной будет PostgreSQL, при этом вы можете выбрать любую, удобную вам (допускается in-memory реализация).

## **Ход решения**

Если у вас возникнут вопросы по заданию, ответы на которые вы не найдёте в описанных «Условиях», вы вольны принимать решения самостоятельно.  
В таком случае приложите к проекту README-файл, в котором будет список вопросов и пояснения о том, какие допущения вы сделали и почему именно выбранным вами способом.

## **Оформление решения**

Необходимо предоставить публичный git-репозиторий на любом публичном хосте (GitHub / GitLab / etc), содержащий в master/main ветке:

1. Код сервиса
2. Makefile c командами сборки проекта / Описанная в README.md инструкция по запуску
3. Описанные в README.md вопросы/проблемы, с которыми столкнулись, и ваша логика их решений (если требуется)

## **Быстрый старт**
1. `make docker-up` или `docker-compose up`
2. `make load-test`
3. `make test`

## Вопросы и решения

### 1. Решение требования "при переназначении новый ревьювер выбирается из команды заменяемого ревьювера"

**Решение:** Реализована логика выбора из команды автора PR. При этом исключаются:
- Автор PR
- Заменяемый ревьювер
- Текущие назначенные ревьюверы

### 2. Балансировка нагрузки при назначении ревьюверов

**Решение:** Реализован механизм балансировки `selectReviewersWithBalancing()`, который:
- Подсчитывает количество активных (OPEN) PR у каждого пользователя
- Приоритизирует пользователей с наименьшей нагрузкой
- Использует таблицу `assignment_stats` для отслеживания всех назначений

### 3. Обработка деактивации пользователей

**Проблема:** Что делать с открытыми PR, где деактивированный пользователь является ревьювером?

**Решение:** При деактивации пользователя:
- Автоматически удаляется из всех открытых PR в качестве ревьювера
- Это предотвращает ситуацию, когда неактивный пользователь блокирует review процесс
- Повторное назначение не выполняется автоматически — атвор PR должен явно вызвать reassign

### 4. Идемпотентность операции merge

**Решение:** При повторном вызове `/pullRequest/merge`:
- Проверяется текущий статус PR
- Если уже MERGED — возвращается текущее состояние без ошибки
- Если OPEN — выполняется merge с установкой `merged_at`

### 5. Статистика (дополнительное задание)

**Реализация:**
- Эндпоинт `/stats?type=users` — количество назначений по пользователям
- Эндпоинт `/stats?type=prs` — количество ревьюверов по PR
- Отдельная таблица `assignment_stats` для подсчёта
- Запись статистики при каждом назначении ревьювера

### 6. Нагрузочное тестирование (дополнительное задание)

**Реализация:**
- Утилита `loadtest/main.go` с конфигурируемой нагрузкой
- 10 параллельных воркеров, 30 секунд тестирования
- Виды операций: 60% создание PR, 20% получение reviews, 20% получение команд
- Автоматическая проверка SLI требований (300ms latency, 99.9% success rate)

### 7. Тестирование (дополнительное задание)

**Реализация:**
- Unit-тесты для сервисного слоя (`internal/service/*_test.go`)
- Тестирование с реальной БД PostgreSQL
- Покрытие основных сценариев:
  - Создание PR с автоназначением
  - Merge операции и идемпотентность
  - Переназначение ревьюверов
  - Граничные случаи (дубликаты, отсутствие кандидатов)